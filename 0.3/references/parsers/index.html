
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
      
      <link rel="shortcut icon" href="../../assets/images/crowdsec2.png">
      <meta name="generator" content="mkdocs-1.1.2, mkdocs-material-6.2.4">
    
    
      
        <title>Parsers - Crowdsec</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/main.15aa0b43.min.css">
      
        
        <link rel="stylesheet" href="../../assets/stylesheets/palette.75751829.min.css">
        
          
          
          <meta name="theme-color" content="">
        
      
    
    
    
      
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Montserrat:300,400,400i,700%7C&display=fallback">
        <style>body,input{font-family:"Montserrat",-apple-system,BlinkMacSystemFont,Helvetica,Arial,sans-serif}code,kbd,pre{font-family:"",SFMono-Regular,Consolas,Menlo,monospace}</style>
      
    
    
    
    
      
    
    
  </head>
  
  
    
    
    
    
    
    <body dir="ltr" data-md-color-scheme="" data-md-color-primary="#3d85c6" data-md-color-accent="">
      
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#understanding-parsers" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
      

<header class="md-header" data-md-component="header">
  <nav class="md-header-nav md-grid" aria-label="Header">
    <a href="../.." title="Crowdsec" class="md-header-nav__button md-logo" aria-label="Crowdsec">
      
  <img src="../../assets/images/crowdsec2.png" alt="logo">

    </a>
    <label class="md-header-nav__button md-icon" for="__drawer">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2z"/></svg>
    </label>
    <div class="md-header-nav__title" data-md-component="header-title">
      <div class="md-header-nav__ellipsis">
        <div class="md-header-nav__topic">
          <span class="md-ellipsis">
            Crowdsec
          </span>
        </div>
        <div class="md-header-nav__topic">
          <span class="md-ellipsis">
            
              Parsers
            
          </span>
        </div>
      </div>
    </div>
    
      <label class="md-header-nav__button md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0116 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 019.5 16 6.5 6.5 0 013 9.5 6.5 6.5 0 019.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg>
      </label>
      
<div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" data-md-state="active" required>
      <label class="md-search__icon md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0116 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 019.5 16 6.5 6.5 0 013 9.5 6.5 6.5 0 019.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
      </label>
      <button type="reset" class="md-search__icon md-icon" aria-label="Clear" data-md-component="search-reset" tabindex="-1">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41z"/></svg>
      </button>
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
      <div class="md-header-nav__source">
        
<a href="https://github.com/crowdsecurity/crowdsec/" title="Go to repository" class="md-source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path d="M439.55 236.05L244 40.45a28.87 28.87 0 00-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 01-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 000 40.81l195.61 195.6a28.86 28.86 0 0040.8 0l194.69-194.69a28.86 28.86 0 000-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
      </div>
    
  </nav>
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
<nav class="md-tabs" aria-label="Tabs" data-md-component="tabs">
  <div class="md-tabs__inner md-grid">
    <ul class="md-tabs__list">
      
        
  
  


  <li class="md-tabs__item">
    <a href="../.." class="md-tabs__link">
      Home
    </a>
  </li>

      
        
  
  


  <li class="md-tabs__item">
    <a href="https://crowdsecurity.github.io/api_doc/index.html?urls.primaryName=LAPI" target="_blank" class="md-tabs__link">
      API Swagger
    </a>
  </li>

      
        
  
  


  <li class="md-tabs__item">
    <a href="https://hub.crowdsec.net/" target="_blank" class="md-tabs__link">
      Hub
    </a>
  </li>

      
        
  
  


  <li class="md-tabs__item">
    <a href="https://github.com/crowdsecurity/crowdsec/releases" target="_blank" class="md-tabs__link">
      Releases
    </a>
  </li>

      
        
  
  


  
  
  
    <li class="md-tabs__item">
      <a href="../../contributing/" class="md-tabs__link">
        Contributing
      </a>
    </li>
  

      
        
  
  


  
  
  
    <li class="md-tabs__item">
      <a href="../../faq/" class="md-tabs__link">
        FAQ
      </a>
    </li>
  

      
    </ul>
  </div>
</nav>
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    



  


<nav class="md-nav md-nav--primary md-nav--lifted" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../.." title="Crowdsec" class="md-nav__button md-logo" aria-label="Crowdsec">
      
  <img src="../../assets/images/crowdsec2.png" alt="logo">

    </a>
    Crowdsec
  </label>
  
    <div class="md-nav__source">
      
<a href="https://github.com/crowdsecurity/crowdsec/" title="Go to repository" class="md-source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path d="M439.55 236.05L244 40.45a28.87 28.87 0 00-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 01-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 000 40.81l195.61 195.6a28.86 28.86 0 0040.8 0l194.69-194.69a28.86 28.86 0 000-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      



  <li class="md-nav__item">
    <a href="../.." class="md-nav__link">
      Home
    </a>
  </li>

    
      
      
      



  <li class="md-nav__item">
    <a href="https://crowdsecurity.github.io/api_doc/index.html?urls.primaryName=LAPI" target="_blank" class="md-nav__link">
      API Swagger
    </a>
  </li>

    
      
      
      



  <li class="md-nav__item">
    <a href="https://hub.crowdsec.net/" target="_blank" class="md-nav__link">
      Hub
    </a>
  </li>

    
      
      
      



  <li class="md-nav__item">
    <a href="https://github.com/crowdsecurity/crowdsec/releases" target="_blank" class="md-nav__link">
      Releases
    </a>
  </li>

    
      
      
      



  
  <li class="md-nav__item md-nav__item--nested">
    
    
      <input class="md-nav__toggle md-toggle" data-md-toggle="nav-5" data-md-state="indeterminate" type="checkbox" id="nav-5" checked>
    
    <label class="md-nav__link" for="nav-5">
      Contributing
      <span class="md-nav__icon md-icon"></span>
    </label>
    <nav class="md-nav" aria-label="Contributing" data-md-level="1">
      <label class="md-nav__title" for="nav-5">
        <span class="md-nav__icon md-icon"></span>
        Contributing
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          



  <li class="md-nav__item">
    <a href="../../contributing/" class="md-nav__link">
      Guide
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      



  
  <li class="md-nav__item md-nav__item--nested">
    
    
      <input class="md-nav__toggle md-toggle" data-md-toggle="nav-6" data-md-state="indeterminate" type="checkbox" id="nav-6" checked>
    
    <label class="md-nav__link" for="nav-6">
      FAQ
      <span class="md-nav__icon md-icon"></span>
    </label>
    <nav class="md-nav" aria-label="FAQ" data-md-level="1">
      <label class="md-nav__title" for="nav-6">
        <span class="md-nav__icon md-icon"></span>
        FAQ
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          



  <li class="md-nav__item">
    <a href="../../faq/" class="md-nav__link">
      Questions
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    
<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#understanding-parsers" class="md-nav__link">
    Understanding parsers
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#stages" class="md-nav__link">
    Stages
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#parser-configuration-format" class="md-nav__link">
    Parser configuration format
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#parser-trees" class="md-nav__link">
    Parser trees
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#parser-directives" class="md-nav__link">
    Parser directives
  </a>
  
    <nav class="md-nav" aria-label="Parser directives">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#debug" class="md-nav__link">
    debug
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#filter" class="md-nav__link">
    filter
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#grok" class="md-nav__link">
    grok
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#name" class="md-nav__link">
    name
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#nodes" class="md-nav__link">
    nodes
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#onsuccess" class="md-nav__link">
    onsuccess
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#pattern_syntax" class="md-nav__link">
    pattern_syntax
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#statics" class="md-nav__link">
    statics
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#data" class="md-nav__link">
    data
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#parser-concepts" class="md-nav__link">
    Parser concepts
  </a>
  
    <nav class="md-nav" aria-label="Parser concepts">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#success-and-failure" class="md-nav__link">
    Success and failure
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content">
            <article class="md-content__inner md-typeset">
              
                
                  <a href="https://github.com/crowdsecurity/crowdsec/edit/master/docs/references/parsers.md" title="Edit this page" class="md-content__button md-icon">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20.71 7.04c.39-.39.39-1.04 0-1.41l-2.34-2.34c-.37-.39-1.02-.39-1.41 0l-1.84 1.83 3.75 3.75M3 17.25V21h3.75L17.81 9.93l-3.75-3.75L3 17.25z"/></svg>
                  </a>
                
                
                  <h1>Parsers</h1>
                
                <h2 id="understanding-parsers">Understanding parsers<a class="headerlink" href="#understanding-parsers" title="Permanent link">&para;</a></h2>
<p>A parser is a YAML configuration file that describes how a string is being parsed. Said string can be a log line, or a field extracted from a previous parser. While a lot of parsers rely on the <strong>GROK</strong> approach (a.k.a regular expression named capture groups), parsers can as well reference enrichment modules to allow specific data processing, or use specific <a href="/Crowdsec/v0/write_configurations/expressions/">expr</a> feature to perform parsing on specific data, such as JSON.</p>
<p>Parsers are organized into stages to allow pipelines and branching in parsing.</p>
<p>See the <a href="https://hub.crowdsec.net/">Crowdsec Hub</a> to explore parsers, or see below some examples :</p>
<ul>
<li><a href="https://github.com/crowdsecurity/hub/blob/master/parsers/s01-parse/crowdsecurity/apache2-logs.yaml">apache2 access/error log parser</a></li>
<li><a href="https://github.com/crowdsecurity/hub/blob/master/parsers/s01-parse/crowdsecurity/iptables-logs.yaml">iptables logs parser</a></li>
<li><a href="https://github.com/crowdsecurity/hub/blob/master/parsers/s02-enrich/crowdsecurity/http-logs.yaml">http logs post-processing</a></li>
</ul>
<h2 id="stages">Stages<a class="headerlink" href="#stages" title="Permanent link">&para;</a></h2>
<p>Stages concept is central to data parsing in Crowdsec, as it allows to have various "steps" of parsing. All parsers belong to a given stage. While users can add or modify the stages order, the following stages exist :</p>
<ul>
<li><code>s00-raw</code> : low level parser, such as syslog</li>
<li><code>s01-parse</code> :  most of the services parsers (ssh, nginx etc.)</li>
<li><code>s02-enrich</code> : enrichment that requires parsed events (ie. geoip-enrichment) or generic parsers that apply on parsed logs (ie. second stage http parser)</li>
</ul>
<p>Every event starts in the first stage, and will move to the next stage once it has been successfully processed by a parser that has the <code>onsuccess</code> directive set to <code>next_stage</code>, and so on until it reaches the last stage, when it's going to start to be matched against scenarios. Thus a sshd log might follow this pipeline :</p>
<ul>
<li><code>s00-raw</code> : be parsed by <code>crowdsecurity/syslog-logs</code> (will move event to the next stage)</li>
<li><code>s01-raw</code> : be parsed by <code>crowdsecurity/sshd-logs</code> (will move event to the next stage)</li>
<li><code>s02-enrich</code> : will be parsed by <code>crowdsecurity/geoip-enrich</code> and <code>crowdsecurity/dateparse-enrich</code></li>
</ul>
<h2 id="parser-configuration-format">Parser configuration format<a class="headerlink" href="#parser-configuration-format" title="Permanent link">&para;</a></h2>
<p>A parser node might look like :</p>
<div class="codehilite"><pre><span></span><code><span class="c1">#if &#39;onsuccess&#39; is &#39;next_stage&#39;, the event will make it to next stage if this node succeed</span>
<span class="nt">onsuccess</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">next_stage</span>
<span class="c1">#a &#39;debug&#39; (bool) flag allow to enable node level debug  in any node to enable local debug</span>
<span class="nt">debug</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">true</span>
<span class="c1">#a filter to decide if the Event is elligible for this parser node</span>
<span class="nt">filter</span><span class="p">:</span> <span class="s">&quot;evt.Parsed.program</span><span class="nv"> </span><span class="s">==</span><span class="nv"> </span><span class="s">&#39;kernel&#39;&quot;</span>
<span class="c1">#a unique name to allow easy debug &amp; logging</span>
<span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">crowdsecurity/demo-iptables</span>
<span class="c1">#this is for humans</span>
<span class="nt">description</span><span class="p">:</span> <span class="s">&quot;Parse</span><span class="nv"> </span><span class="s">iptables</span><span class="nv"> </span><span class="s">drop</span><span class="nv"> </span><span class="s">logs&quot;</span>
<span class="c1">#we can define named capture groups (a-la-grok)</span>
<span class="nt">pattern_syntax</span><span class="p">:</span>
  <span class="nt">MYCAP</span><span class="p">:</span> <span class="s">&quot;.*&quot;</span>
<span class="c1">#an actual grok pattern (regular expression with named capture groupe)</span>
<span class="nt">grok</span><span class="p">:</span>
  <span class="nt">pattern</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">^xxheader %{MYCAP:extracted_value} trailing stuff$</span>
  <span class="c1">#we define on which field the regular expression must be applied</span>
  <span class="nt">apply_on</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">evt.Parsed.some_field</span>
<span class="c1">#statics are transformations that are applied on the event if the node is considered &quot;successfull&quot;</span>
<span class="nt">statics</span><span class="p">:</span>
  <span class="p p-Indicator">-</span> <span class="nt">parsed</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">something</span>
    <span class="nt">expression</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">JsonExtract(evt.Event.extracted_value, &quot;nested.an_array[0]&quot;)</span>
  <span class="c1">#to which field the value will be written (here -&gt; evt.Meta.log_type)</span>
  <span class="p p-Indicator">-</span> <span class="nt">meta</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">log_type</span>
    <span class="c1">#and here a static value</span>
    <span class="nt">value</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">parsed_testlog</span>
  <span class="c1">#another one</span>
  <span class="p p-Indicator">-</span> <span class="nt">meta</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">source_ip</span>
    <span class="c1">#here the value stored is the result of a dynamic expression</span>
    <span class="nt">expression</span><span class="p">:</span> <span class="s">&quot;evt.Parsed.src_ip&quot;</span>
</code></pre></div>

<p>The parser nodes are processed sequentially based on the alphabetical order of <a href="/Crowdsec/v0/getting_started/concepts/#stages">stage</a> and subsequent files.
If the node is considered successful (grok is present and returned data or no grok is present) and "onsuccess" equals to <code>next_stage</code>, then the event is moved to the next stage.</p>
<h2 id="parser-trees">Parser trees<a class="headerlink" href="#parser-trees" title="Permanent link">&para;</a></h2>
<p>A parser node can contain sub-nodes, to provide proper branching (on top of stages).
It can be useful when you want to apply different parsing based on different criterias, or when you have a set of candidates parsers that you want to apply to an event :</p>
<div class="codehilite"><pre><span></span><code><span class="c1">#This first node will capture/extract some value</span>
<span class="nt">filter</span><span class="p">:</span> <span class="s">&quot;evt.Line.Labels.type</span><span class="nv"> </span><span class="s">==</span><span class="nv"> </span><span class="s">&#39;type1&#39;&quot;</span>
<span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">tests/base-grok-root</span>
<span class="nt">pattern_syntax</span><span class="p">:</span>
  <span class="nt">MYCAP</span><span class="p">:</span> <span class="s">&quot;.*&quot;</span>
<span class="nt">grok</span><span class="p">:</span>
  <span class="nt">pattern</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">^... %{MYCAP:extracted_value} ...$</span>
  <span class="nt">apply_on</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">Line.Raw</span>
<span class="nt">statics</span><span class="p">:</span>
  <span class="p p-Indicator">-</span> <span class="nt">meta</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">state</span>
    <span class="nt">value</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">root-done</span>
  <span class="p p-Indicator">-</span> <span class="nt">meta</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">state_sub</span>
    <span class="nt">expression</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">evt.Parsed.extracted_value</span>
<span class="nn">---</span>
<span class="c1">#and this node will apply different patterns to it</span>
<span class="nt">filter</span><span class="p">:</span> <span class="s">&quot;evt.Line.Labels.type</span><span class="nv"> </span><span class="s">==</span><span class="nv"> </span><span class="s">&#39;type1&#39;</span><span class="nv"> </span><span class="s">&amp;&amp;</span><span class="nv"> </span><span class="s">evt.Meta.state</span><span class="nv"> </span><span class="s">==</span><span class="nv"> </span><span class="s">&#39;root-done&#39;&quot;</span>
<span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">tests/base-grok-leafs</span>
<span class="nt">onsuccess</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">next_stage</span>
<span class="c1">#the sub-nodes will process the result of the master node</span>
<span class="nt">nodes</span><span class="p">:</span>
  <span class="p p-Indicator">-</span> <span class="nt">filter</span><span class="p">:</span> <span class="s">&quot;evt.Parsed.extracted_value</span><span class="nv"> </span><span class="s">==</span><span class="nv"> </span><span class="s">&#39;VALUE1&#39;&quot;</span>
    <span class="nt">debug</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">true</span>
    <span class="nt">statics</span><span class="p">:</span>
      <span class="p p-Indicator">-</span> <span class="nt">meta</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">final_state</span>
        <span class="nt">value</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">leaf1</span>
  <span class="p p-Indicator">-</span> <span class="nt">filter</span><span class="p">:</span> <span class="s">&quot;evt.Parsed.extracted_value</span><span class="nv"> </span><span class="s">==</span><span class="nv"> </span><span class="s">&#39;VALUE2&#39;&quot;</span>
    <span class="nt">debug</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">true</span>
    <span class="nt">statics</span><span class="p">:</span>
      <span class="p p-Indicator">-</span> <span class="nt">meta</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">final_state</span>
        <span class="nt">value</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">leaf2</span>
</code></pre></div>

<p>The logic is that the <code>tests/base-grok-root</code> node will be processed first and will alter the event (here mostly by extracting some text from the <code>Line.Raw</code> field into <code>Parsed</code> thanks to the <code>grok</code> pattern and the <code>statics</code> directive).</p>
<p>The event will then continue its life and be parsed by the the following <code>tests/base-grok-leafs</code> node.
This node has <code>onsuccess</code> set to <code>next_stage</code> which means that if the node is successful, the event will be moved to the next stage.</p>
<p>This node consists actually of two sub-nodes that have different conditions (branching) to allow differential treatment of said event.</p>
<p>A real-life example can be seen when it comes to parsing HTTP logs.
HTTP ACCESS and ERROR logs often have different formats, and thus our "nginx" parser needs to handle both formats</p>
<div class="codehilite"><pre><span></span><code><span class="nt">filter</span><span class="p">:</span> <span class="s">&quot;evt.Parsed.program</span><span class="nv"> </span><span class="s">==</span><span class="nv"> </span><span class="s">&#39;nginx&#39;&quot;</span>
<span class="nt">onsuccess</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">next_stage</span>
<span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">crowdsecurity/nginx-logs</span>
<span class="nt">nodes</span><span class="p">:</span>
  <span class="p p-Indicator">-</span> <span class="nt">grok</span><span class="p">:</span>
      <span class="c1">#this is the access log</span>
      <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">NGINXACCESS</span>
      <span class="nt">apply_on</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">message</span>
      <span class="nt">statics</span><span class="p">:</span>
        <span class="p p-Indicator">-</span> <span class="nt">meta</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">log_type</span>
          <span class="nt">value</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">http_access-log</span>
        <span class="p p-Indicator">-</span> <span class="nt">target</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">evt.StrTime</span>
          <span class="nt">expression</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">evt.Parsed.time_local</span>
  <span class="p p-Indicator">-</span> <span class="nt">grok</span><span class="p">:</span>
        <span class="c1"># and this one the error log</span>
        <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">NGINXERROR</span>
        <span class="nt">apply_on</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">message</span>
        <span class="nt">statics</span><span class="p">:</span>
          <span class="p p-Indicator">-</span> <span class="nt">meta</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">log_type</span>
            <span class="nt">value</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">http_error-log</span>
          <span class="p p-Indicator">-</span> <span class="nt">target</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">evt.StrTime</span>
            <span class="nt">expression</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">evt.Parsed.time</span>
<span class="c1"># these ones apply for both grok patterns</span>
<span class="nt">statics</span><span class="p">:</span>
  <span class="p p-Indicator">-</span> <span class="nt">meta</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">service</span>
    <span class="nt">value</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">http</span>
  <span class="p p-Indicator">-</span> <span class="nt">meta</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">source_ip</span>
    <span class="nt">expression</span><span class="p">:</span> <span class="s">&quot;evt.Parsed.remote_addr&quot;</span>
  <span class="p p-Indicator">-</span> <span class="nt">meta</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">http_status</span>
    <span class="nt">expression</span><span class="p">:</span> <span class="s">&quot;evt.Parsed.status&quot;</span>
  <span class="p p-Indicator">-</span> <span class="nt">meta</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">http_path</span>
    <span class="nt">expression</span><span class="p">:</span> <span class="s">&quot;evt.Parsed.request&quot;</span>
</code></pre></div>

<h2 id="parser-directives">Parser directives<a class="headerlink" href="#parser-directives" title="Permanent link">&para;</a></h2>
<h3 id="debug">debug<a class="headerlink" href="#debug" title="Permanent link">&para;</a></h3>
<div class="codehilite"><pre><span></span><code><span class="nt">debug</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">true|false</span>
</code></pre></div>

<p><em>default: false</em></p>
<p>If set to to <code>true</code>, enabled node level debugging.
It is meant to help understanding parser node behavior by providing contextual logging :</p>
<details>
  <summary>assignments made by statics</summary>

<div class="codehilite"><pre><span></span><code>DEBU[31-07-2020 16:36:28] + Processing 4 statics                        id=withered-rain name=crowdsecurity/nginx-logs stage=s01-parse
DEBU[31-07-2020 16:36:28] .Meta[service] = &#39;http&#39;                       id=withered-rain name=crowdsecurity/nginx-logs stage=s01-parse
DEBU[31-07-2020 16:36:28] .Meta[source_ip] = &#39;127.0.0.1&#39;                id=withered-rain name=crowdsecurity/nginx-logs stage=s01-parse
DEBU[31-07-2020 16:36:28] .Meta[http_status] = &#39;200&#39;                    id=withered-rain name=crowdsecurity/nginx-logs stage=s01-parse
DEBU[31-07-2020 16:36:28] .Meta[http_path] = &#39;/&#39;                        id=withered-rain name=crowdsecurity/nginx-logs stage=s01-parse
</code></pre></div>


</details>
<details>
  <summary>assignments made by grok pattern</summary>

<div class="codehilite"><pre><span></span><code>DEBU[31-07-2020 16:36:28] + Grok &#39;NGINXACCESS&#39; returned 10 entries to merge in Parsed  id=dark-glitter name=child-crowdsecurity/nginx-logs stage=s01-parse
DEBU[31-07-2020 16:36:28]   .Parsed[&#39;time_local&#39;] = &#39;21/Jul/2020:16:13:05 +0200&#39;  id=dark-glitter name=child-crowdsecurity/nginx-logs stage=s01-parse
DEBU[31-07-2020 16:36:28]   .Parsed[&#39;method&#39;] = &#39;GET&#39;                    id=dark-glitter name=child-crowdsecurity/nginx-logs stage=s01-parse
DEBU[31-07-2020 16:36:28]   .Parsed[&#39;request&#39;] = &#39;/&#39;                     id=dark-glitter name=child-crowdsecurity/nginx-logs stage=s01-parse
DEBU[31-07-2020 16:36:28]   .Parsed[&#39;http_user_agent&#39;] = &#39;curl/7.58.0&#39;   id=dark-glitter name=child-crowdsecurity/nginx-logs stage=s01-parse
DEBU[31-07-2020 16:36:28]   .Parsed[&#39;remote_addr&#39;] = &#39;127.0.0.1&#39;         id=dark-glitter name=child-crowdsecurity/nginx-logs stage=s01-parse
</code></pre></div>


</details>
<details>
  <summary>debug of filters and expression results</summary>

<div class="codehilite"><pre><span></span><code>DEBU[31-07-2020 16:36:28] eval(evt.Parsed.program == &#39;nginx&#39;) = TRUE    id=withered-rain name=crowdsecurity/nginx-logs stage=s01-parse
DEBU[31-07-2020 16:36:28] eval variables:                               id=withered-rain name=crowdsecurity/nginx-logs stage=s01-parse
DEBU[31-07-2020 16:36:28]        evt.Parsed.program = &#39;nginx&#39;           id=withered-rain name=crowdsecurity/nginx-logs stage=s01-parse
</code></pre></div>


</details>

<h3 id="filter">filter<a class="headerlink" href="#filter" title="Permanent link">&para;</a></h3>
<div class="codehilite"><pre><span></span><code><span class="nt">filter</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">expression</span>
</code></pre></div>

<p><code>filter</code> must be a valid <a href="/Crowdsec/v0/write_configurations/expressions/">expr</a> expression that will be evaluated against the <a href="/Crowdsec/v0/getting_started/concepts/#event">event</a>.</p>
<p>If <code>filter</code> evaluation returns true or is absent, node will be processed.</p>
<p>If <code>filter</code> returns <code>false</code> or a non-boolean, node won't be processed.</p>
<p>Here is the <a href="https://github.com/antonmedv/expr/tree/master/docs">expr documentation</a>.</p>
<p>Examples :</p>
<ul>
<li><code>filter: "evt.Meta.foo == 'test'"</code></li>
<li><code>filter: "evt.Meta.bar == 'test' &amp;&amp; evt.Meta.foo == 'test2'</code></li>
</ul>
<h3 id="grok">grok<a class="headerlink" href="#grok" title="Permanent link">&para;</a></h3>
<div class="codehilite"><pre><span></span><code><span class="nt">grok</span><span class="p">:</span>
  <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">NAMED_EXISTING_PATTERN</span>
  <span class="nt">apply_on</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">source_field</span>
</code></pre></div>

<div class="codehilite"><pre><span></span><code><span class="nt">grok</span><span class="p">:</span>
  <span class="nt">pattern</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">^a valid RE2 expression with %{CAPTURE:field}$</span>
  <span class="nt">apply_on</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">source_field</span>
</code></pre></div>

<p>The <code>grok</code> structure in a node represent a regular expression with capture group (grok pattern) that must be applied on a field of event.</p>
<p>The pattern can : </p>
<ul>
<li>be imported by name (if present within the core of Crowdsec)</li>
<li>defined in place</li>
</ul>
<p>In both case, the pattern must be a valid RE2 expression.
The field(s) returned by the regular expression are going to be merged into the <code>Parsed</code> associative array of the <code>Event</code>.</p>
<h3 id="name">name<a class="headerlink" href="#name" title="Permanent link">&para;</a></h3>
<div class="codehilite"><pre><span></span><code><span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">explicit_string</span>
</code></pre></div>

<p>The <em>mandatory</em> name of the node. If not present, node will be skipped at runtime.
It is used for example in debug log to help you track things.</p>
<h3 id="nodes">nodes<a class="headerlink" href="#nodes" title="Permanent link">&para;</a></h3>
<div class="codehilite"><pre><span></span><code><span class="nt">nodes</span><span class="p">:</span>
 <span class="p p-Indicator">-</span> <span class="nt">filter</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">...</span>
   <span class="nt">grok</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">...</span>
</code></pre></div>

<p><code>nodes</code> is a list of parser nodes, allowing you to build trees.
Each subnode must be valid, and if any of the subnodes succeed, the whole node is considered successful. </p>
<h3 id="onsuccess">onsuccess<a class="headerlink" href="#onsuccess" title="Permanent link">&para;</a></h3>
<div class="codehilite"><pre><span></span><code>onsuccess: next_stage|continue
</code></pre></div>

<p><em>default: continue</em></p>
<p>if set to <code>next_stage</code> and the node is considered successful, the event will be moved directly to next stage without processing other nodes in the current stage.</p>
<h3 id="pattern_syntax">pattern_syntax<a class="headerlink" href="#pattern_syntax" title="Permanent link">&para;</a></h3>
<div class="codehilite"><pre><span></span><code><span class="nt">pattern_syntax</span><span class="p">:</span>
  <span class="nt">CAPTURE_NAME</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">VALID_RE2_EXPRESSION</span>
</code></pre></div>

<p><code>pattern_syntax</code> allows user to define named capture group expressions for future use in grok patterns.
Regexp must be a valid RE2 expression.</p>
<div class="codehilite"><pre><span></span><code><span class="nt">pattern_syntax</span><span class="p">:</span>
  <span class="nt">MYCAP</span><span class="p">:</span> <span class="s">&quot;.*&quot;</span>
<span class="nt">grok</span><span class="p">:</span>
  <span class="nt">pattern</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">^xxheader %{MYCAP:extracted_value} trailing stuff$</span>
  <span class="nt">apply_on</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">Line.Raw</span>
</code></pre></div>

<h3 id="statics">statics<a class="headerlink" href="#statics" title="Permanent link">&para;</a></h3>
<div class="codehilite"><pre><span></span><code><span class="nt">statics</span><span class="p">:</span>
 <span class="p p-Indicator">-</span> <span class="nt">target</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">evt.Meta.target_field</span>
   <span class="nt">value</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">static_value</span>
 <span class="p p-Indicator">-</span> <span class="nt">meta</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">target_field</span>
   <span class="nt">expression</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">evt.Meta.target_field + &#39; this_is&#39; + &#39; a dynamic expression&#39;</span>
 <span class="p p-Indicator">-</span> <span class="nt">enriched</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">target_field</span>
   <span class="nt">value</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">static_value</span>
</code></pre></div>

<p><code>statics</code> is a list of directives that will be executed when the node is considered successful.
Each entry of the list is composed of a target (where to write) and a source (what data to write).</p>
<p><strong>Target</strong></p>
<p>The target aims at being any part of the <a href="/Crowdsec/v0/getting_started/concepts/#event">event</a> object, and can be expressed in different ways :</p>
<div class="codehilite"><pre><span></span><code>- `meta: &lt;target_field&gt;`
- `parsed: &lt;target_field&gt;`
- `enriched: &lt;target_field&gt;`
- a dynamic target (please note that the **current** event is accessible via the `evt.` variable) :
     - `target: evt.Meta.foobar`
     - `target: Meta.foobar`
     - `target: evt.StrTime`
</code></pre></div>

<p><strong>Source</strong></p>
<p>The source itself can be either a static value, or an <a href="/Crowdsec/v0/write_configurations/expressions/">expr</a> result :</p>
<div class="codehilite"><pre><span></span><code><span class="nt">statics</span><span class="p">:</span>
  <span class="p p-Indicator">-</span> <span class="nt">meta</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">target_field</span>
    <span class="nt">value</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">static_value</span>
  <span class="p p-Indicator">-</span> <span class="nt">meta</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">target_field</span>
    <span class="nt">expression</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">evt.Meta.another_field</span>
  <span class="p p-Indicator">-</span> <span class="nt">meta</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">target_field</span>
    <span class="nt">expression</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">evt.Meta.target_field + &#39; this_is&#39; + &#39; a dynamic expression&#39;</span>
</code></pre></div>

<h3 id="data">data<a class="headerlink" href="#data" title="Permanent link">&para;</a></h3>
<div class="codehilite"><pre><span></span><code>data:
  - source_url: https://URL/TO/FILE
    dest_file: LOCAL_FILENAME
    [type: (regexp|string)]
</code></pre></div>

<p><code>data</code> allows user to specify an external source of data.
This section is only relevant when <code>cscli</code> is used to install parser from hub, as it will download the <code>source_url</code> and store it to <code>dest_file</code>. When the parser is not installed from the hub, Crowdsec won't download the URL, but the file must exist for the parser to be loaded correctly.</p>
<p>The <code>type</code> is mandatory if you want to evaluate the data in the file, and should be <code>regex</code> for valid (re2) regular expression per line or <code>string</code> for string per line.
The regexps will be compiled, the strings will be loaded into a list and both will be kept in memory.
Without specifying a <code>type</code>, the file will be downloaded and stored as file and not in memory.</p>
<div class="codehilite"><pre><span></span><code><span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">crowdsecurity/cdn-whitelist</span>
<span class="nn">...</span>
<span class="nt">data</span><span class="p">:</span>
  <span class="p p-Indicator">-</span> <span class="nt">source_url</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">https://www.cloudflare.com/ips-v4</span>
    <span class="nt">dest_file</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">cloudflare_ips.txt</span>
    <span class="nt">type</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">string</span>
</code></pre></div>

<h2 id="parser-concepts">Parser concepts<a class="headerlink" href="#parser-concepts" title="Permanent link">&para;</a></h2>
<h3 id="success-and-failure">Success and failure<a class="headerlink" href="#success-and-failure" title="Permanent link">&para;</a></h3>
<p>A parser is considered "successful" if :</p>
<ul>
<li>A grok pattern was present and successfully matched</li>
<li>No grok pattern was present</li>
</ul>
                
              
              
                


              
            </article>
          </div>
        </div>
      </main>
      
        
<footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-footer-copyright">
        
        Made with
        <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
          Material for MkDocs
        </a>
      </div>
      
    </div>
  </div>
</footer>
      
    </div>
    
      <script src="../../assets/javascripts/vendor.93c04032.min.js"></script>
      <script src="../../assets/javascripts/bundle.83e5331e.min.js"></script><script id="__lang" type="application/json">{"clipboard.copy": "Copy to clipboard", "clipboard.copied": "Copied to clipboard", "search.config.lang": "en", "search.config.pipeline": "trimmer, stopWordFilter", "search.config.separator": "[\\s\\-]+", "search.placeholder": "Search", "search.result.placeholder": "Type to start searching", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.term.missing": "Missing"}</script>
      
      <script>
        app = initialize({
          base: "../..",
          features: ['navigation.tabs', 'navigation.expand', 'navigation.instant', 'navigation.section'],
          search: Object.assign({
            worker: "../../assets/javascripts/worker/search.8c7e0a7e.min.js"
          }, typeof search !== "undefined" && search)
        })
      </script>
      
    
  </body>
</html>